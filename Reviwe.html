<!-- Review.html -->
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    window.onload = () => {
      // ‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏±‡πâ‡∏ô & ‡πÅ‡∏¢‡∏Å query
      const qs     = new URLSearchParams(window.location.search);
      let actual   = qs.get('liff.state') || window.location.search;
      try {
        while(actual.includes('%')) {
          const d = decodeURIComponent(actual);
          if (d===actual) break;
          actual = d;
        }
      } catch{}
      const P = new URLSearchParams(actual.replace(/^\?/, ''));

      // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤
      const id         = P.get('id')         || '';
      const eventId    = P.get('eventId')    || '';
      const bookerName = P.get('bookerName') || '';
      const date       = P.get('date')       || '';
      const time       = P.get('time')       || '';
      const useridline = P.get('useridline') || '';

      // ‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤
      document.getElementById('displayId').textContent         = id;
      document.getElementById('displayEventId').textContent    = eventId;
      document.getElementById('displayBookerName').textContent = bookerName;
      document.getElementById('displayDate').textContent       = date;
      document.getElementById('displayTime').textContent       = time;

      // ‡∏ã‡πà‡∏≠‡∏ô input
      ['id','eventId','bookerName','date','time','useridline']
        .forEach(k => document.getElementById(k).value = eval(k));
    };

    async function submitReview(e) {
      e.preventDefault();
      const f = document.getElementById('reviewForm');
      const scores = ['service','service0','service1','service2','service3']
        .map(k => Number(f[k].value));
      const total = scores.reduce((a,b)=>a+b,0);
      const payload = {
        method:       'insertReviewData',
        id:           f.id.value,
        eventId:      f.eventId.value,
        bookerName:   f.bookerName.value,
        date:         f.date.value,
        time:         f.time.value,
        service:      scores[0],
        service0:     scores[1],
        service1:     scores[2],
        service2:     scores[3],
        service3:     scores[4],
        totalScore:   total,
        useridline:   f.useridline.value
      };
      try {
        const res = await fetch('https://script.google.com/macros/s/AKfycbwOiSYN37QTLiFdz8F0VfVBHGGsoA7Rn6DoAQn0ZBa7Ss6E-UP6WDZVncDgnVby1cVOyQ/exec', {
          method:'POST',
          body:  JSON.stringify(payload)
        });
        document.getElementById('status').textContent =
          res.ok ? '‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏µ‡∏ß‡∏¥‡∏ß üôè' : '‚ùå ‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      } catch {
        document.getElementById('status').textContent = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
      }
    }
  </script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
    <h2 class="text-2xl font-bold mb-4 text-center">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h2>
    <div class="mb-6 text-gray-700">
      <p>‡∏£‡∏´‡∏±‡∏™‡∏à‡∏≠‡∏á: <span id="displayId" class="font-medium">‚Äì</span></p>
      <p>‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°: <span id="displayEventId" class="font-medium">‚Äì</span></p>
      <p>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô: <span id="displayBookerName" class="font-medium">‚Äì</span></p>
      <p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span id="displayDate" class="font-medium">‚Äì</span> ‡πÄ‡∏ß‡∏•‡∏≤: <span id="displayTime" class="font-medium">‚Äì</span></p>
    </div>
    <form id="reviewForm" class="space-y-4" onsubmit="submitReview(event)">
      <input type="hidden" id="id" name="id"/>
      <input type="hidden" id="eventId" name="eventId"/>
      <input type="hidden" id="bookerName" name="bookerName"/>
      <input type="hidden" id="date" name="date"/>
      <input type="hidden" id="time" name="time"/>
      <input type="hidden" id="useridline" name="useridline"/>

      <!-- 5 ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° -->
      <div><label>‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏° (1‚Äì5)</label>
        <select id="service" name="service" class="w-full border p-2 rounded">
          <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
        </select>
      </div>
      <!-- ‡∏ã‡πâ‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö service0‚Äìservice3 -->
      <div><label>‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£0</label><select id="service0" name="service0" class="w-full border p-2 rounded">
        <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
      </select></div>
      <div><label>‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£1</label><select id="service1" name="service1" class="w-full border p-2 rounded">
        <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
      </select></div>
      <div><label>‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£2</label><select id="service2" name="service2" class="w-full border p-2 rounded">
        <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
      </select></div>
      <div><label>‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£3</label><select id="service3" name="service3" class="w-full border p-2 rounded">
        <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
      </select></div>

      <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded">‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</button>
    </form>
    <p id="status" class="mt-4 text-center text-gray-700"></p>
  </div>
</body>
</html>
