<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>จองกิจกรรม</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/th.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="config.js"></script>
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
  <style>
    @keyframes spin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
    .loader {border:8px solid #f3f3f3;border-top:8px solid #071d4a;border-radius:50%;width:64px;height:64px;animation:spin 1s linear infinite;}
  </style>
</head>
<body class="bg-gradient-to-b from-blue-200 via-purple-100 to-white min-h-screen relative">
  <div id="loadingOverlay" class="fixed inset-0 flex items-center justify-center bg-[#071d4a] bg-opacity-50 z-50 hidden"><div class="loader"></div></div>

  <!-- STEP 1: เลือกกิจกรรม -->
  <div id="step1" class="p-4 max-w-md mx-auto">
    <h1 class="text-xl font-bold text-center mb-4">เลือกกิจกรรม</h1>
    <div id="step1EventList" class="grid grid-cols-2 gap-4"></div>
  </div>

  <!-- STEP 2: รายละเอียดกิจกรรม -->
  <div id="step2" class="hidden p-4 max-w-md mx-auto">
    <button id="backToStep1" class="mb-4 px-4 py-2 border rounded-full">กลับ</button>
    <img id="detailMainImg" class="w-full h-48 object-cover rounded-2xl mb-4" />
    <h2 id="detailEventName" class="text-lg font-bold"></h2>
    <p id="detailEventCategory" class="text-sm text-gray-500 mb-1"></p>
    <div class="flex justify-between items-center mb-2">
      <div id="detailEventDateTime" class="text-sm text-gray-700"></div>
      <div id="detailEventQueue" class="text-sm text-red-500"></div>
    </div>
    <div id="detailEventPrice" class="text-xl font-bold text-red-500 mb-4"></div>
    <div id="detailGallery" class="flex space-x-2 overflow-x-auto mb-4"></div>
    <p id="detailEventDesc" class="text-sm text-gray-700 mb-2"></p>
    <p id="detailEventDesc2" class="text-sm text-gray-700 mb-4"></p>
    <button id="detailBookBtn" class="w-full py-2 rounded-2xl text-white">
      จองกิจกรรมนี้
    </button>
  </div>

  <!-- STEP 3: ฟอร์มจอง -->
  <div id="step3" class="hidden p-4 max-w-md mx-auto">
    <button id="backToStep2" class="mb-4 px-4 py-2 border rounded-full">กลับ</button>
    <form id="bookingForm" class="space-y-4 bg-white p-4 rounded-2xl shadow">
      <input type="hidden" id="bookEventId" required />
      ...
    </form>
  </div>

  <script>
    // Helpers
    function formatDate(d) {const dt=new Date(d);return `${String(dt.getDate()).padStart(2,'0')}-${String(dt.getMonth()+1).padStart(2,'0')}-${dt.getFullYear()}`;}
    function formatTime(d) {const dt=new Date(d);return `${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;}
    let eventsData=[],selectedEvent=null;
    document.addEventListener('DOMContentLoaded',async()=>{
      await liff.init({liffId:'2007305761-opN68Y00'});
      if(!liff.isLoggedIn())liff.login();
      document.getElementById('bookUserLineId').value=(await liff.getProfile()).userId;
      await fetchAllEvents();
    });
    function showLoading(){document.getElementById('loadingOverlay').classList.remove('hidden');}
    function hideLoading(){document.getElementById('loadingOverlay').classList.add('hidden');}
    async function fetchAllEvents(){showLoading();try{const res=await fetch(API_URL);eventsData=await res.json();renderEventList(eventsData);}catch(e){console.error(e);}finally{hideLoading();}}
    function renderEventList(events){const c=document.getElementById('step1EventList');c.innerHTML='';events.forEach(evt=>{const booked=Number(evt['คิว'])||0,tot=Number(evt['จำนวน'])||0;const card=document.createElement('div');card.className='relative glass p-2 rounded-2xl shadow flex flex-col items-center';const img=document.createElement('img');img.src=evt['รูปภาพ'];img.className='w-full h-24 object-cover rounded-lg mb-2';const title=document.createElement('div');title.textContent=evt['ชื่อ'];const badge=document.createElement('div');badge.className='absolute top-2 right-2 bg-black bg-opacity-60 text-white text-xs px-2 py-1 rounded-full';badge.textContent=`${booked}/${tot}`;const btn=document.createElement('button');if(booked>=tot){btn.textContent='ครบจำนวนแล้ว';btn.disabled=true;btn.className='mt-2 bg-gray-400 text-white px-4 py-1 rounded-2xl cursor-not-allowed';}else{btn.textContent='เลือก';btn.className='mt-2 bg-orange-500 text-white px-4 py-1 rounded-2xl';btn.onclick=()=>{selectedEvent=evt;showStep('step2');populateDetail();};}card.append(img,title,badge,btn);c.appendChild(card);});}
    function populateDetail(){showStep('step2');const booked=Number(selectedEvent['คิว'])||0,tot=Number(selectedEvent['จำนวน'])||0;document.getElementById('detailMainImg').src=selectedEvent['รูปภาพ'];document.getElementById('detailEventName').textContent=selectedEvent['ชื่อ'];document.getElementById('detailEventCategory').textContent=selectedEvent['หมวดหมู่'];document.getElementById('detailEventDateTime').textContent=`${formatDate(selectedEvent['วันที่'])} เวลา ${formatTime(selectedEvent['เวลา'])}`;document.getElementById('detailEventQueue').textContent=`${booked}/${tot}`;document.getElementById('detailEventPrice').textContent=selectedEvent['ราคา'];document.getElementById('detailEventDesc').textContent=selectedEvent['รายละเอียด'];document.getElementById('detailEventDesc2').textContent=selectedEvent['รายละเอียด-2'];const gal=document.getElementById('detailGallery');gal.innerHTML='';['รูปประกอบ-1','รูปประกอบ-2','รูปประกอบ-3','รูปประกอบ-4'].forEach(k=>{if(selectedEvent[k]){const t=document.createElement('img');t.src=selectedEvent[k];t.className='w-20 h-20 object-cover rounded-2xl cursor-pointer';t.onclick=()=>document.getElementById('detailMainImg').src=selectedEvent[k];gal.appendChild(t);}});const btn=document.getElementById('detailBookBtn');if(booked>=tot){btn.textContent='ครบจำนวนแล้ว';btn.disabled=true;btn.className='w-full py-2 rounded-2xl text-white bg-gray-400 cursor-not-allowed';}else{btn.textContent='จองกิจกรรมนี้';btn.disabled=false;btn.className='w-full py-2 rounded-2xl text-white bg-[#071d4a]';btn.onclick=()=>{showStep('step3');populateBookingForm();}}}
    function populateBookingForm(){showStep('step3');document.getElementById('bookEventId').value=selectedEvent['ไอดีกิจกรรม'];document.getElementById('bookEventName').value=selectedEvent['ชื่อ'];document.getElementById('bookEventCategory').value=selectedEvent['หมวดหมู่'];document.getElementById('bookEventPrice').value=selectedEvent['ราคา'];document.getElementById('bookEventDate').value=formatDate(selectedEvent['วันที่']);document.getElementById('bookEventTime').value=formatTime(selectedEvent['เวลา']);}
    function showStep(id){['step1','step2','step3'].forEach(s=>document.getElementById(s).classList.add('hidden'));document.getElementById(id).classList.remove('hidden');}
    async function submitBooking(){showLoading();try{const payload={eventId:document.getElementById('bookEventId').value,true,eventName:document.getElementById('bookEventName').value,category:document.getElementById('bookEventCategory').value,price:document.getElementById('bookEventPrice').value,date:document.getElementById('bookEventDate').value,time:document.getElementById('bookEventTime').value,queue:document.getElementById('bookQueue').value,renterName:document.getElementById('bookRenterName').value,phone:document.getElementById('bookPhone').value,email:document.getElementById('bookEmail').value,note:document.getElementById('bookNote').value,userLineId:document.getElementById('bookUserLineId').value};document.getElementById('debugData').textContent=JSON.stringify(payload,null,2);await fetch(API_URL,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});await fetchAllEvents();showStep('step1');alert('จองสำเร็จ');}catch(e){console.error(e);alert('ไม่สามารถจองได้ กรุณาลองใหม่');}finally{hideLoading();}}  </script>
</body>
</html>
