<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>รีวิวกิจกรรม</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" />
  <style>
    .star-rating { direction: rtl; display: inline-block; }
    .star-rating input[type="radio"] { display: none; }
    .star-rating label { color: #ccc; font-size: 1.5rem; cursor: pointer; }
    .star-rating input[type="radio"]:checked ~ label,
    .star-rating label:hover,
    .star-rating label:hover ~ label { color: #f5b301; }
  </style>
</head>
<body class="text-sm">
  <div class="max-w-md mx-auto bg-white p-6 mt-6">
    <h1 class="text-xl font-bold text-[#0A164D] mb-4">แบบประเมินกิจกรรม</h1>
    <form id="feedbackForm">
      <input type="hidden" id="roomId" name="roomId" />
      <input type="hidden" id="userIdLine" name="userIdLine" />

      <div class="mb-3">
        <label class="block text-gray-700">ชื่อกิจกรรม</label>
        <input type="text" id="roomName" name="roomName" class="w-full p-2 bg-gray-100 rounded" readonly />
      </div>
      <div class="mb-3">
        <label class="block text-gray-700">ชื่อผู้เข้าร่วม</label>
        <input type="text" id="bookerName" name="bookerName" class="w-full p-2 bg-gray-100 rounded" readonly />
      </div>
      <div class="flex gap-4 mb-6">
        <div class="flex-1">
          <label class="block text-gray-700">วันที่</label>
          <input type="text" id="date" name="date" class="w-full p-2 bg-gray-100 rounded" readonly />
        </div>
        <div class="flex-1">
          <label class="block text-gray-700">เวลา</label>
          <input type="text" id="time" name="time" class="w-full p-2 bg-gray-100 rounded" readonly />
        </div>
      </div>

      <!-- คำถาม 1 -->
      <div class="mb-6">
        <p class="text-gray-700 mb-2">1. ความน่าสนใจของหัวข้อและเนื้อหาของกิจกรรม</p>
        <div class="star-rating">
          <input type="radio" id="interest5" name="interest" value="5" /><label for="interest5"><i class="fas fa-star"></i></label>
          <input type="radio" id="interest4" name="interest" value="4" /><label for="interest4"><i class="fas fa-star"></i></label>
          <input type="radio" id="interest3" name="interest" value="3" /><label for="interest3"><i class="fas fa-star"></i></label>
          <input type="radio" id="interest2" name="interest" value="2" /><label for="interest2"><i class="fas fa-star"></i></label>
          <input type="radio" id="interest1" name="interest" value="1" required /><label for="interest1"><i class="fas fa-star"></i></label>
        </div>
      </div>

      <!-- คำถาม 2 -->
      <div class="mb-6">
        <p class="text-gray-700 mb-2">2. รูปแบบการดำเนินกิจกรรมมีความเหมาะสม</p>
        <div class="star-rating">
          <input type="radio" id="format5" name="format" value="5" /><label for="format5"><i class="fas fa-star"></i></label>
          <input type="radio" id="format4" name="format" value="4" /><label for="format4"><i class="fas fa-star"></i></label>
          <input type="radio" id="format3" name="format" value="3" /><label for="format3"><i class="fas fa-star"></i></label>
          <input type="radio" id="format2" name="format" value="2" /><label for="format2"><i class="fas fa-star"></i></label>
          <input type="radio" id="format1" name="format" value="1" required /><label for="format1"><i class="fas fa-star"></i></label>
        </div>
      </div>

      <!-- คำถาม 3 -->
      <div class="mb-6">
        <p class="text-gray-700 mb-2">3. การประชาสัมพันธ์และการสมัครเข้าร่วมของกิจกรรมมีความเหมาะสม</p>
        <div class="star-rating">
          <input type="radio" id="publicity5" name="publicity" value="5" /><label for="publicity5"><i class="fas fa-star"></i></label>
          <input type="radio" id="publicity4" name="publicity" value="4" /><label for="publicity4"><i class="fas fa-star"></i></label>
          <input type="radio" id="publicity3" name="publicity" value="3" /><label for="publicity3"><i class="fas fa-star"></i></label>
          <input type="radio" id="publicity2" name="publicity" value="2" /><label for="publicity2"><i class="fas fa-star"></i></label>
          <input type="radio" id="publicity1" name="publicity" value="1" required /><label for="publicity1"><i class="fas fa-star"></i></label>
        </div>
      </div>

      <!-- คำถาม 4 -->
      <div class="mb-6">
        <p class="text-gray-700 mb-2">4. วิทยากรหรือผู้ดำเนินกิจกรรมมีความเหมาะสม</p>
        <div class="star-rating">
          <input type="radio" id="speaker5" name="speaker" value="5" /><label for="speaker5"><i class="fas fa-star"></i></label>
          <input type="radio" id="speaker4" name="speaker" value="4" /><label for="speaker4"><i class="fas fa-star"></i></label>
          <input type="radio" id="speaker3" name="speaker" value="3" /><label for="speaker3"><i class="fas fa-star"></i></label>
          <input type="radio" id="speaker2" name="speaker" value="2" /><label for="speaker2"><i class="fas fa-star"></i></label>
          <input type="radio" id="speaker1" name="speaker" value="1" required /><label for="speaker1"><i class="fas fa-star"></i></label>
        </div>
      </div>

      <!-- คำถาม 5 -->
      <div class="mb-6">
        <p class="text-gray-700 mb-2">5. ความคุ้มค่าของกิจกรรม สามารถนำเอาประสบการณ์ที่ได้รับไปต่อยอดได้</p>
        <div class="star-rating">
          <input type="radio" id="value5" name="value" value="5" /><label for="value5"><i class="fas fa-star"></i></label>
          <input type="radio" id="value4" name="value" value="4" /><label for="value4"><i class="fas fa-star"></i></label>
          <input type="radio" id="value3" name="value" value="3" /><label for="value3"><i class="fas fa-star"></i></label>
          <input type="radio" id="value2" name="value" value="2" /><label for="value2"><i class="fas fa-star"></i></label>
          <input type="radio" id="value1" name="value" value="1" required /><label for="value1"><i class="fas fa-star"></i></label>
        </div>
      </div>

      <!-- คำถาม 6 -->
      <div class="mb-6">
        <p class="text-gray-700 mb-2">6. ความเหมาะสมของสถานที่และอุปกรณ์อำนวยความสะดวก</p>
        <div class="star-rating">
          <input type="radio" id="equipment5" name="equipment" value="5" /><label for="equipment5"><i class="fas fa-star"></i></label>
          <input type="radio" id="equipment4" name="equipment" value="4" /><label for="equipment4"><i class="fas fa-star"></i></label>
          <input type="radio" id="equipment3" name="equipment" value="3" /><label for="equipment3"><i class="fas fa-star"></i></label>
          <input type="radio" id="equipment2" name="equipment" value="2" /><label for="equipment2"><i class="fas fa-star"></i></label>
          <input type="radio" id="equipment1" name="equipment" value="1" required /><label for="equipment1"><i class="fas fa-star"></i></label>
        </div>
      </div>

      <!-- คำถาม 7 -->
      <div class="mb-6">
        <p class="text-gray-700 mb-2">7. ความเหมาะสมของวันเวลาที่จัดกิจกรรม</p>
        <div class="star-rating">
          <input type="radio" id="schedule5" name="schedule" value="5" /><label for="schedule5"><i class="fas fa-star"></i></label>
          <input type="radio" id="schedule4" name="schedule" value="4" /><label for="schedule4"><i class="fas fa-star"></i></label>
          <input type="radio" id="schedule3" name="schedule" value="3" /><label for="schedule3"><i class="fas fa-star"></i></label>
          <input type="radio" id="schedule2" name="schedule" value="2" /><label for="schedule2"><i class="fas fa-star"></i></label>
          <input type="radio" id="schedule1" name="schedule" value="1" required /><label for="schedule1"><i class="fas fa-star"></i></label>
        </div>
      </div>

      <!-- คำถาม 8 -->
      <div class="mb-6">
        <p class="text-gray-700 mb-2">8. สรุปภาพรวมความพึงพอใจที่ท่านได้รับจากการจัดกิจกรรมในครั้งนี้</p>
        <textarea id="overall" name="overall" rows="3" class="w-full p-2 border rounded" required></textarea>
      </div>

      <button type="submit" class="w-full p-3 bg-[#0A164D] text-white font-bold rounded hover:bg-blue-600">
        ส่งความคิดเห็น
      </button>
    </form>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const state = decodeURIComponent(urlParams.get("liff.state") || "").replace(/^\?/, "");
    const p = new URLSearchParams(state);

    document.getElementById("roomId").value = p.get("eventId") || "";
    document.getElementById("roomName").value = p.get("activity") || "";
    document.getElementById("bookerName").value = p.get("bookerName") || "";
    document.getElementById("date").value = p.get("date") || "";
    document.getElementById("time").value = p.get("time") || "";
    document.getElementById("userIdLine").value = p.get("useridline") || "";

    document.getElementById("feedbackForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const data = {
        method: "submitFeedback",
        roomId: document.getElementById("roomId").value,
        roomName: document.getElementById("roomName").value,
        bookerName: document.getElementById("bookerName").value,
        date: document.getElementById("date").value,
        time: document.getElementById("time").value,
        userIdLine: document.getElementById("userIdLine").value,
        interest: document.querySelector('input[name="interest"]:checked')?.value || "",
        format: document.querySelector('input[name="format"]:checked')?.value || "",
        publicity: document.querySelector('input[name="publicity"]:checked')?.value || "",
        speaker: document.querySelector('input[name="speaker"]:checked')?.value || "",
        value: document.querySelector('input[name="value"]:checked')?.value || "",
        equipment: document.querySelector('input[name="equipment"]:checked')?.value || "",
        schedule: document.querySelector('input[name="schedule"]:checked')?.value || "",
        overall: document.getElementById("overall").value.trim()
      };

      // ตรวจสอบครบทุกข้อ
      if (!(data.interest && data.format && data.publicity && data.speaker &&
            data.value && data.equipment && data.schedule && data.overall)) {
        Swal.fire("กรุณาตอบแบบประเมินทุกข้อ", "", "error");
        return;
      }

      Swal.fire({ title: "กำลังส่งข้อมูล...", didOpen: () => Swal.showLoading(), allowOutsideClick: false });
      fetch("https://script.google.com/macros/s/AKfycbxtbN_-k9O_yxP1QTsXsQajYwLh4yL8oEG_eA5iKofRcCTuKTO8KL0ghJMDiDbMQ34nxQ/exec", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams(data)
      })
      .then(res => res.json())
      .then(res => {
        if (res.success) {
          Swal.fire("ส่งเรียบร้อย", "ขอบคุณสำหรับความคิดเห็น!", "success").then(() => window.close());
        } else {
          Swal.fire("ผิดพลาด", res.message || "ไม่สามารถบันทึกข้อมูลได้", "error");
        }
      })
      .catch(() => Swal.fire("ผิดพลาด", "ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์", "error"));
    });
  </script>
</body>
</html>
