<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>จองกิจกรรม</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/th.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="config.js"></script>
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
  <style>
    @keyframes spin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
    .loader {border:8px solid #f3f3f3;border-top:8px solid #071d4a;border-radius:50%;width:64px;height:64px;animation:spin 1s linear infinite;}
  </style>
</head>
<body class="bg-gradient-to-b from-blue-200 via-purple-100 to-white min-h-screen relative">
  <div id="loadingOverlay" class="fixed inset-0 flex items-center justify-center bg-[#071d4a] bg-opacity-50 z-50 hidden"><div class="loader"></div></div>

  <!-- STEP 1 -->
  <div id="step1" class="p-4 max-w-md mx-auto">
    <h1 class="text-xl font-bold text-center mb-4">เลือกกิจกรรม</h1>
    <div id="step1EventList" class="grid grid-cols-2 gap-4"></div>
  </div>

  <!-- STEP 2 -->
  <div id="step2" class="hidden p-4 max-w-md mx-auto">
    <button id="backToStep1" class="mb-4 px-4 py-2 border rounded-full">กลับ</button>
    <img id="detailMainImg" class="w-full h-48 object-cover rounded-2xl mb-4">
    <h2 id="detailEventName" class="text-lg font-bold"></h2>
    <p id="detailEventCategory" class="text-sm text-gray-500 mb-1"></p>
    <div class="flex justify-between mb-2"><div id="detailEventDateTime" class="text-sm text-gray-700"></div><div id="detailEventQueue" class="text-sm text-red-500"></div></div>
    <div id="detailEventPrice" class="text-xl font-bold text-red-500 mb-4"></div>
    <div id="detailGallery" class="flex space-x-2 overflow-x-auto mb-4"></div>
    <p id="detailEventDesc" class="text-sm text-gray-700 mb-2"></p>
    <p id="detailEventDesc2" class="text-sm text-gray-700 mb-4"></p>
    <button id="detailBookBtn" class="bg-[#071d4a] text-white w-full py-2 rounded-2xl">จองกิจกรรมนี้</button>
  </div>

  <!-- STEP 3 -->
  <div id="step3" class="hidden p-4 max-w-md mx-auto">
    <button id="backToStep2" class="mb-4 px-4 py-2 border rounded-full">กลับ</button>
    <form id="bookingForm" class="space-y-4 bg-white p-4 rounded-2xl shadow">
      <input type="hidden" id="bookEventId" required>
      <div><label class="text-xs text-gray-500">ชื่อกิจกรรม</label><input id="bookEventName" class="w-full border-b" readonly></div>
      <div class="grid grid-cols-2 gap-4"><div><label class="text-xs text-gray-500">หมวดหมู่</label><input id="bookEventCategory" class="w-full border-b" readonly></div><div><label class="text-xs text-gray-500">ราคา</label><input id="bookEventPrice" class="w-full border-b" readonly></div></div>
      <div class="grid grid-cols-2 gap-4"><div><label class="text-xs text-gray-500">วันที่</label><input id="bookEventDate" class="w-full border-b" readonly></div><div><label class="text-xs text-gray-500">เวลา</label><input id="bookEventTime" class="w-full border-b" readonly></div></div>
      <div><label class="text-sm font-semibold mb-1">คิวที่</label><input id="bookQueue" type="number" min="1" value="1" class="w-full border rounded-2xl p-2" required></div>
      <div><label class="text-sm font-semibold mb-1">ชื่อผู้จอง</label><input id="bookRenterName" class="w-full border rounded-2xl p-2" required></div>
      <div><label class="text-sm font-semibold mb-1">เบอร์ติดต่อ</label><input id="bookPhone" class="w-full border rounded-2xl p-2" required></div>
      <div><label class="text-sm font-semibold mb-1">อีเมล</label><input id="bookEmail" class="w-full border rounded-2xl p-2"></div>
      <div><label class="text-sm font-semibold mb-1">หมายเหตุ</label><textarea id="bookNote" rows="3" class="w-full border rounded-2xl p-2"></textarea></div>
      <input id="bookUserLineId" type="hidden" required>
      <button type="button" id="submitBookingBtn" class="bg-[#071d4a] text-white w-full py-3 rounded-2xl">บันทึกการจอง</button>
    </form>
    <pre id="debugData" class="mt-4 p-2 bg-gray-100 text-xs overflow-auto max-h-40"></pre>
  </div>

  <script>
    // Helpers
    function formatDate(d) {const dt=new Date(d);return dt.getDate().toString().padStart(2,'0')+'-'+(dt.getMonth()+1).toString().padStart(2,'0')+'-'+dt.getFullYear();}
    function formatTime(d) {const dt=new Date(d);return dt.getHours().toString().padStart(2,'0')+':'+dt.getMinutes().toString().padStart(2,'0');}
    let eventsData=[],selectedEvent=null;
    document.addEventListener('DOMContentLoaded',async()=>{
      await liff.init({liffId:'2007305761-opN68Y00'});
      if(!liff.isLoggedIn()) liff.login();
      const profile=await liff.getProfile();
      document.getElementById('bookUserLineId').value=profile.userId;
      await fetchAllEvents();
      document.getElementById('submitBookingBtn').onclick=submitBooking;
      document.getElementById('detailBookBtn').onclick=populateBookingForm;
      document.getElementById('backToStep1').onclick=()=>showStep('step1');
      document.getElementById('backToStep2').onclick=()=>showStep('step2');
    });
    function showLoading(){document.getElementById('loadingOverlay').classList.remove('hidden');}
    function hideLoading(){document.getElementById('loadingOverlay').classList.add('hidden');}
    async function fetchAllEvents(){showLoading();try{const res=await fetch(API_URL);eventsData=await res.json();renderEventList(eventsData);}catch(e){console.error(e);}finally{hideLoading();}}
    function renderEventList(evts){const c=document.getElementById('step1EventList');c.innerHTML='';evts.forEach(evt=>{const card=document.createElement('div');card.className='glass p-2 rounded-2xl shadow flex flex-col items-center';const img=document.createElement('img');img.src=evt['รูปภาพ'];img.className='w-full h-24 object-cover rounded-lg mb-2';const title=document.createElement('div');title.textContent=evt['ชื่อ'];const bk=Number(evt['คิว'])||0,tt=Number(evt['จำนวน'])||0;const badge=document.createElement('div');badge.className='absolute top-2 right-2 bg-black bg-opacity-60 text-white text-xs px-2 py-1 rounded-full';badge.textContent=`${bk}/${tt}`;const btn=document.createElement('button');btn.textContent='เลือก';btn.className='mt-2 bg-orange-500 text-white px-4 py-1 rounded-2xl';btn.onclick=()=>{selectedEvent=evt;showStep('step2');populateDetail();};card.append(img,title,badge,btn);c.appendChild(card);});}
    function populateDetail(){showStep('step2');document.getElementById('detailMainImg').src=selectedEvent['รูปภาพ'];document.getElementById('detailEventName').textContent=selectedEvent['ชื่อ'];document.getElementById('detailEventCategory').textContent=selectedEvent['หมวดหมู่'];const fd=formatDate(selectedEvent['วันที่']),ft=formatTime(selectedEvent['เวลา']);document.getElementById('detailEventDateTime').textContent=`${fd} เวลา ${ft}`;const bk=Number(selectedEvent['คิว'])||0,tot=Number(selectedEvent['จำนวน'])||0;document.getElementById('detailEventQueue').textContent=`${bk}/${tot}`;document.getElementById('detailEventPrice').textContent=selectedEvent['ราคา'];document.getElementById('detailEventDesc').textContent=selectedEvent['รายละเอียด'];document.getElementById('detailEventDesc2').textContent=selectedEvent['รายละเอียด-2'];const gal=document.getElementById('detailGallery');gal.innerHTML='';['รูปประกอบ-1','รูปประกอบ-2','รูปประกอบ-3','รูปประกอบ-4'].forEach(k=>{if(selectedEvent[k]){const t=document.createElement('img');t.src=selectedEvent[k];t.className='w-20 h-20 object-cover rounded-2xl cursor-pointer';t.onclick=()=>document.getElementById('detailMainImg').src=selectedEvent[k];gal.appendChild(t);}})}
    function populateBookingForm(){showStep('step3');document.getElementById('bookEventId').value=selectedEvent['ไอดีกิจกรรม'];document.getElementById('bookEventName').value=selectedEvent['ชื่อ'];document.getElementById('bookEventCategory').value=selectedEvent['หมวดหมู่'];document.getElementById('bookEventPrice').value=selectedEvent['ราคา'];document.getElementById('bookEventDate').value=formatDate(selectedEvent['วันที่']);document.getElementById('bookEventTime').value=formatTime(selectedEvent['เวลา']);}
    function showStep(id){['step1','step2','step3'].forEach(s=>document.getElementById(s).classList.add('hidden'));document.getElementById(id).classList.remove('hidden');}
    async function submitBooking(){showLoading();const payload={eventId:document.getElementById('bookEventId').value,eventName:document.getElementById('bookEventName').value,category:document.getElementById('bookEventCategory').value,price:document.getElementById('bookEventPrice').value,date:document.getElementById('bookEventDate').value,time:document.getElementById('bookEventTime').value,queue:document.getElementById('bookQueue').value,renterName:document.getElementById('bookRenterName').value,phone:document.getElementById('bookPhone').value,email:document.getElementById('bookEmail').value,note:document.getElementById('bookNote').value,userLineId:document.getElementById('bookUserLineId').value};document.getElementById('debugData').textContent=JSON.stringify(payload,null,2);try{await fetch(API_URL,{method:'POST',mode:'no-cors',headers:{ 'Content-Type':'application/json' },body:JSON.stringify(payload)});await fetchAllEvents();showStep('step1');alert('จองสำเร็จ');}catch(e){console.error(e);alert('ไม่สามารถจองได้');}finally{hideLoading();}}  </script>
</body>
</html>
